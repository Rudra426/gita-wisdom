<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Viveka — Ancient Wisdom</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<div class="grain"></div>

<div class="app">

  <header>
    <div class="logo">ॐ Viveka</div>
    <div class="logo-sub">Ancient wisdom for modern life</div>
  </header>

  <div class="messages" id="messages">
    <div class="welcome" id="welcome">
      <div class="welcome-symbol">॥</div>
      <h2>What are you carrying today?</h2>
      <p>Bring any question, any confusion, any weight — and we will look for the answer together in the oldest wisdom humanity has written down.</p>
      <div class="welcome-prompts">
        <button class="prompt-chip" onclick="usePrompt(this)">I feel lost about what direction to take in my life</button>
        <button class="prompt-chip" onclick="usePrompt(this)">I'm struggling with anger I can't seem to control</button>
        <button class="prompt-chip" onclick="usePrompt(this)">I work hard but nothing seems to go my way</button>
        <button class="prompt-chip" onclick="usePrompt(this)">I'm afraid of failing and it's stopping me from trying</button>
      </div>
    </div>
  </div>

  <div class="input-area">
    <div class="input-wrap">
      <textarea
        id="input"
        placeholder="Ask anything..."
        rows="1"
        onkeydown="handleKey(event)"
        oninput="autoResize(this)"
      ></textarea>
      <button class="send-btn" id="sendBtn" onclick="sendMessage()" title="Send">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      </button>
    </div>
    <div class="input-hint">Write in any language — English, हिंदी, ગુજરાતી</div>
  </div>

</div>

<script>
  let history = [];
  let isLoading = false;

  function autoResize(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 160) + 'px';
  }

  function handleKey(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  }

  function usePrompt(btn) {
    const input = document.getElementById('input');
    input.value = btn.textContent;
    autoResize(input);
    input.focus();
  }

  function hideWelcome() {
    const welcome = document.getElementById('welcome');
    if (welcome) {
      welcome.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
      welcome.style.opacity = '0';
      welcome.style.transform = 'translateY(-8px)';
      setTimeout(() => welcome.remove(), 300);
    }
  }

  function addMessage(role, text) {
    hideWelcome();
    const container = document.getElementById('messages');
    const div = document.createElement('div');
    div.className = `message ${role}`;
    div.innerHTML = `
      <div class="message-label">${role === 'user' ? 'You' : 'Viveka'}</div>
      <div class="message-content">${text.replace(/\n/g, '<br>')}</div>
    `;
    container.appendChild(div);
    setTimeout(() => container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' }), 50);
  }

  function showTyping() {
    const container = document.getElementById('messages');
    const div = document.createElement('div');
    div.className = 'typing-wrap';
    div.id = 'typing';
    div.innerHTML = `
      <div class="message-label">Viveka</div>
      <div class="typing"><span></span><span></span><span></span></div>
    `;
    container.appendChild(div);
    setTimeout(() => container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' }), 50);
  }

  function removeTyping() {
    const t = document.getElementById('typing');
    if (t) t.remove();
  }

  async function sendMessage() {
    if (isLoading) return;
    const input = document.getElementById('input');
    const message = input.value.trim();
    if (!message) return;

    input.value = '';
    input.style.height = 'auto';
    isLoading = true;
    document.getElementById('sendBtn').disabled = true;

    addMessage('user', message);
    showTyping();

    try {
      const res = await fetch('/api/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message, history })
      });

      const data = await res.json();
      removeTyping();

      if (data.error) {
        addMessage('ai', 'Something went wrong. Please try again.');
      } else {
        addMessage('ai', data.reply);
        history.push({ role: 'user', content: message });
        history.push({ role: 'assistant', content: data.reply });
        if (history.length > 20) history = history.slice(-20);
      }
    } catch (err) {
      removeTyping();
      addMessage('ai', 'Could not connect to the server. Make sure it is running.');
    }

    isLoading = false;
    document.getElementById('sendBtn').disabled = false;
    input.focus();
  }
</script>

</body>
</html>